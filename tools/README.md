# 概要
PSD形式の画像ファイルからレイヤーを抽出して合成し、Arduino用で使用できるC++のソースコード形式(RGB565)に変換します。複数のレイヤーを合成して1つの画像データにしたり、複数の画像データを一括で1つのファイルに変換することができます。

※本プログラムは坂本アヒルさんの[ずんだもんの立ち絵素材](https://www.pixiv.net/artworks/92641351)の使用を想定しています。他は動作確認をしていません。

# とりあえずすぐに変換したい
1. Pythonインストールしてない場合は先にインストール。（pythonパッケージ psd-toolsも必要）
2. 立ち絵素材をダウンロードして "ずんだもん立ち絵素材2.3.psd" をこのプログラムと同じフォルダにコピーする。
3. convert_zundamon.bat を実行。
4. image_zundamon.h が完成！

# 動作環境
[Python](https://www.python.org/) で動作します。Windows版Pythonでしか動作確認していません。インストールしていない場合はダウンロードしてインストールしてください。インストールの際、PATHの設定を追加するのを忘れずに。
Pythonをインストールしたら、処理に必要なパッケージをインストールします。
```
pip install psd-tools
```

# 処理の流れ
変換プログラムは2つあります。
1. psdlayers2png.py はPSDファイルを読み込んで各レイヤー毎にPNGファイルに変換します。抽出したレイヤー情報はCSV形式で保存されます。
2. pngmerger_rgb565.py は構成ファイル(.ini)の指示に従い、複数のPNGファイルを合成してRGB565形式で保存します。

# 変換手順
以下の3つのステップで変換していきます。

## (1) PSDファイルの分解
`python psdlayers2png.py "ずんだもん立ち絵素材2.3.psd" image_zundamon_png`

上記コマンドで、ずんだもん立ち絵素材2.3.psdファイルを読み込み、各レイヤーをPNG形式で image_zundamon_png/ フォルダに保存します。またレイヤー名やサイズ情報、ファイル名などを一覧にしたカタログファイルが catalog.csv というファイル名で保存されます。どんな風に分解されたか、まずは表計算ソフト等でカタログファイルを開いてみてください。

## (2) 構成ファイルの作成
作り方はサンプルの image_zundamon.ini を参考にしてください。サンプルのままでも使用できます。

## (3) レイヤーの合成とC++コード変換
`python pngmerger_rgb565.py image_zundamon.ini image_zundamon_png image_zundamon.h`

最後に上記のコマンドで、構成ファイル"image_zundamon.ini"に従い、image_zundamon_png/ フォルダにあるPNGファイルを読み込んで、image_zundamon.h を作成します。

# 変換後のファイル
変換後のファイルはそのまま無編集でズンダチャンのライブラリで使用可能です。変換したコードの先頭には、以下のような配列が記述してあります。ズンダチャンのプログラムでは、これを「テーブル」と呼んでいて、何番目の部位かというのを「インデックス番号」と呼んでいます。

```c:image_zundamon.h
// 画像パーツの部位別テーブル
uint16_t imgTableBody[] = { 0 };
  // [0] = 体　体のみ
uint16_t imgTableRhand[] = { 1, 2, 3, 4 };
  // [0] = 右腕　普通
  // [1] = 右腕　バンザイ
  // [2] = 右腕　指差し
  // [3] = 右腕　腰
```

たとえばプログラム中で「指差し」している右腕の画像を使いたいという場合は imgTableRhand[2] にアクセスします。このデータは構造体になっており、ズンダチャンのアバタークラスの方で以下のように定義されています。

```c:Zundavatar.h
struct ImageInfo {  // 画像データの構造体
  const unsigned short* data;
  const uint16_t width;
  const uint16_t height;
  const uint16_t size;
  const uint16_t posX;
  const uint16_t posY;
  const unsigned short transparent;
};
```

構造体ImageInfoにはRGB565形式の画像の生データ(へのポインタ)、幅(pixel)、高さ(pixel)、バイト数といった基本情報の他に、体(body)から見た相対的な座標と透過カラー情報があります。たとえば右腕(rhand)を表示させたい場合、体(body)からposX, posYぶんずらした位置に配置すれば、正しい位置に右腕が表示されます。これなら画像を差し替えてもプログラムを直す必要なし。簡単ですね！最後の透過カラーは、M5GFXでレイヤーを合成するときに透明として扱う色の情報です。

# 既知の問題（仕様）
半透明のレイヤーは綺麗に出力されません。たとえば坂本アヒルさんの[四国めたんの立ち絵素材](https://www.pixiv.net/artworks/92641379)の場合、ほっぺの赤い部分（*普通2）が赤いグラデーションで作られているので、これを使いたい場合は先に顔のレイヤー（!体）と統合させておく必要があります。これは元画像のアルファチャンネルが256階調なのに対し、ズンダチャンは2値しか情報がないためです。

# サウンドファイルをソースコード形式に変換する
音声ファイルなどのバイナリファイルをC++のソースコード形式(.h)に変換するには、以下のコマンドで行います。以下は音声ファイル input.wav を output.h に変換する例です。

`python file2h.py input.wav output.h`

こちらは先ほどの画像変換（16bit）とは異なり、8bitのunsigned charでの変換になります。

